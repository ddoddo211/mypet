<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="shop">
	
	<!-- 펫쇼핑몰 이벤트List 조회 -->
	<select id="shopNoticeList" resultType="snotVo">
		select * from shopnotice
	</select>
	
	<!-- 펫쇼핑몰 이벤트글 조회 -->
	<select id="shopNoticeDetail" parameterType="String" resultType="snotVo">
		select * from shopnotice
		where snot_id = #{snot_id}
	</select>
	
	<!-- 펫쇼핑몰 강아지/고양이 상품분류(사료,장난감등) -->
	<select id="prodMenu" parameterType="String" resultType="dvsVo">
		SELECT dvs_id,dvs_name, LEVEL
		FROM division
		START WITH dvs_parent = #{dvs_id}
		CONNECT BY PRIOR dvs_id  = dvs_parent
		and level = 1
		ORDER BY to_number(SUBSTR(DVS_ID,4,2))
	</select>
	
	<!-- 펫쇼핑 상품분류에 대한 옵션(연령,브랜드등)List -->
	<select id="prodMenuOption" parameterType="String" resultType="dvsVo">
		SELECT dvs_id,dvs_name, LEVEL
		FROM division
		START WITH dvs_parent = #{dvs_parent}
		CONNECT BY PRIOR dvs_id  = dvs_parent
		and level = 1
	</select>
	
	<!-- 펫쇼핑몰 옵션(연령,브랜드등)에 대한 분류(브랜드명,펫나이등)List -->
	<select id="opMenuList" parameterType="String" resultType="dvsVo">
		SELECT dvs_id,dvs_name,dvs_parent, LEVEL
		FROM division
		where level = 2
		START WITH dvs_parent = #{dvs_parent}
		CONNECT BY PRIOR dvs_id  = dvs_parent
	</select>
	
	<!-- 펫쇼핑몰 체크박스 조건이 없을 경우 상품List -->
	<select id="prodList" parameterType="Map" resultType="prodVo">
		select * from (
			select rownum as rnum,a.* from
    			(SELECT * FROM PROD 
     			WHERE PROD_ID in (SELECT PDD_PROD FROM PRODDV WHERE PDD_DVS = #{dvsVo.dvs_parent})
		     	order by prod_date desc)a
		     )
		where rnum between #{pageVo.page} *#{pageVo.pageSize}-(#{pageVo.pageSize}-1) and #{pageVo.page}*#{pageVo.pageSize}
	</select>
	
	<!-- 펫쇼핑몰 체크박스 조건이 없을 경우 상품리스트 Size -->
	<select id="prodSize" parameterType="String" resultType="int">
		select count(*) 
		from (select * from prod where prod_id in (select pdd_prod from proddv where pdd_dvs = #{dvs_parent}))
	</select>
	
	<!-- 펫쇼핑몰 체크박스 조건이 있을 경우 상품List -->
	<select id="chkList" parameterType="Map" resultType="prodVo">
		select * from (
		select  rownum as rnum,a.* from prod a
		where prod_id in (select pdd_prod from proddv where pdd_dvs in (${op0})
		<foreach collection="opChkList" item="item" index="index">
			and prod_id in (select pdd_prod from proddv where pdd_dvs in (${item}))
		</foreach>
		 )
		)
		where rnum between #{pageVo.page} *#{pageVo.pageSize}-(#{pageVo.pageSize}-1) and #{pageVo.page}*#{pageVo.pageSize}
	</select>
	
	<!-- 펫쇼핑몰 체크박스 조건이 있을 경우 상품리스트 Size -->
	<select id="chkSize" parameterType="Map" resultType="int">
		select count(*) from (
		select  rownum as rnum,a.* from prod a
		where prod_id in (select pdd_prod from proddv where pdd_dvs in (${op0})
		<foreach collection="opChkList" item="item" index="index">
			and prod_id in (select pdd_prod from proddv where pdd_dvs in (${item}))
		</foreach>
		 )
		)
	</select>
	
	<!-- 상품에 옵션List -->
	<select id="prodOpList" parameterType="String" resultType="prodoVo">
		select * from prodoption
		where prodo_prod = #{prod_id}
	</select>
	
	<select resultType="String" id="opChk" parameterType="Map">
		select DVS_ID from division WHERE DVS_PARENT = #{opid} AND dvs_id in 
		<foreach index="index" item="item" collection="valueGo" close=")" open="(" separator=","> 
			#{item} 
		</foreach>
	</select>
	
	<!-- 상품의 대한 상세정보 -->
	<select id="prodDetail" parameterType="String" resultType="prodVo">
		select * from prod
		where prod_id = #{prod_id}
	</select>
	
	
	<!--펫쇼핑몬 메인 사료검색 필요 XML  -->
	
	<!-- 동물 구분 -->
	<select id="animalList" resultType="dvsVo">
		select * from division
		where dvs_parent is null
	</select>
	
	<!-- 동물의 아이디를 받아 해당 동물의 사료id찾기 -->
	<select id="animalSaryo" resultType="String" parameterType="String">
		select * from division
		where dvs_name = '사료'
		start with dvs_parent = #{dvs_id}
		connect by prior dvs_id = dvs_parent
	</select>
	
	<!-- 해당 동물의 브랜드 종류List -->
	<select id="brandSearch" resultType="dvsVo" parameterType="String">
		select * from division
		where dvs_parent = (select dvs_id from division where dvs_name = '브랜드' start with dvs_parent = #{dvs_parent} connect by dvs_id = dvs_parent)
	</select>
	
	
	<!-- 상품 등록  -->
	<insert id="prodCre" parameterType="prodVo">
		insert into prod
		values ('PROD'||PROD_ID.NEXTVAL,#{prod_name},#{prod_price},#{prod_sprice},#{prod_qty},#{prod_pimg},#{prod_img},sysdate,#{prod_mem})
	</insert>
	
	<!-- 상품분류 등록 -->
	<insert id="pddCre" parameterType="pddVo">
		<selectKey resultType="string" keyProperty="pdd_prod" order="BEFORE">
			select max(substr(prod_id,5,4)) from prod
		</selectKey>
		insert into proddv
		values('PDD'||PDD_ID.NEXTVAL,#{pdd_dvs},'PROD'||#{pdd_prod})
	</insert>
	
	<!-- 상품 옵션 등록 -->
	<insert id="prodoCre" parameterType="prodoVo">
		insert into prodoption
		values ('OPTION'||PRODOP_ID.NEXTVAL,#{prodo_name},#{prodo_price},#{prodo_qty},#{prodo_prod})
	</insert>
</mapper>
 