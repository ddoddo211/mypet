<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="petIns">

		<!-- 보험상품 -->
		<!-- 보험상품 리스트 목록가지고 오는 부분 -->
		<select id="prodPageList" parameterType="inspageVo" resultType="inspageVo">
			select * from
			(select ROWNUM rnum,
			A.*
			from (select * from insProd where insp_del = 'N' order by to_number(insp_id) asc) A)
			WHERE rnum between #{page}*#{pageSize}-(#{pageSize}-1) and #{page}*#{pageSize}
		</select>
		
		<!-- 보험상품 총갯수 -->
		<select id="getInsProductCnt" resultType="int">
			select count(*) from insprod
			where insp_del = 'N'
	  	</select>
	  	
	  	<!-- 보험상품 리스트 목록가지고 오는 부분 -->
		<select id="prodKindPageList" parameterType="inspageVo" resultType="inspageVo">
			select * from
			(select ROWNUM rnum,
			A.*
			from (select * from insProd where INSP_JOIN = #{petKind} and insp_del = 'N' order by to_number(insp_id) asc) A)
			WHERE rnum between #{page}*#{pageSize}-(#{pageSize}-1) and #{page}*#{pageSize}
		</select>
		
		<!-- 보험상품 총갯수(조건) -->
		<select id="getInsProductKindCnt" parameterType="String" resultType="int" >
			select count(*) from insprod  where INSP_JOIN = #{petKind} and insp_del = 'N'
	  	</select>
	  	
	  	<!-- 우리아이 보험상품 추천 리스트 가지고 오는 부분 -->
	  	<select id="prodProductRecommendation" parameterType="inspageVo" resultType="insProdVo">
		     select * from
		              (select ROWNUM rnum,
		                      A.*
		               from  (select * from insProd where insp_del = 'N' order by to_number(insp_id) asc)A)
				 WHERE  rnum BETWEEN #{page}*#{pageSize}-(#{pageSize}-1) and #{page}*#{pageSize}
		         and INSP_JOIN = #{petKind}
		         and INSP_MINAGE <![CDATA[<=]]> ${petBirth}
		         and INSP_MAXAGE <![CDATA[>=]]> ${petBirth}
		         and INSP_SICK = #{petSick}
		</select>
		
		<!-- 게시글 총갯수(우리아이보험추천) -->
		<select id="getProductRecommendationCnt" parameterType="inspageVo" resultType="int" >
			select count(*) from insprod 
			 where INSP_JOIN = #{petKind}
		       and INSP_MINAGE <![CDATA[<=]]> to_number(#{petBirth})
		       and INSP_MAXAGE <![CDATA[>=]]> to_number(#{petBirth})
		       and INSP_SICK = #{petSick}
		       and insp_del = 'N'
	  	</select>
		
		<!-- 보험상품 아이디를 매개변수로 줘서 보험상품 정보 가지고 오는 방법 -->
		<select id="getProdInfo" parameterType="String" resultType="insProdVo">
			select * from insprod
			where insp_id = #{prodId}
		</select>
		
		
		<!-- 플랜정보에 보험상품 추가하기 -->
		<insert id="planInsert" parameterType="insShVo">
			insert into insshopping
			values(insShopping_num.nextval,#{inssp_mem},#{inssp_insp})
		</insert>
		
		<!-- 플랜정보에 회원의 플랜정보에 추가된 보험상품 조회 -->
		<select id="memPlan" parameterType="String" resultType="insShVo">
			select * from insshopping , insprod
			 where inssp_insp = insp_id 
               and inssp_mem = #{inssp_mem}
		</select>
		
		<!-- 회원의 펫이 있는지 확인하는 부분 -->
		<select id="petList" parameterType="String" resultType="mypetVo">
			select *
			from mypet , petkind 
			where myp_petk = petk_id
			and myp_del = 'N'
			and myp_mem = #{myp_mem}
			order by myp_id
		</select>
		
		<!-- 회원 정보를 가지고 오는 쿼리 -->
		<select id="memberInfo" parameterType="String" resultType="memVo">
			select *
			  from member
			where mem_id = #{mem_id}
		</select>
		
		<!-- 회원이 플랜정보 추가버튼을 클릭하였을때 이미 플랜정보에 추가되어진 상품인지 확인하는 부분 -->
		<select id="memShopping" parameterType="insShVo" resultType="insShVo">
			select * from insshopping
			where inssp_mem = #{inssp_mem}
			and inssp_insp= #{inssp_insp}
		</select>
		
		<!-- 플랜정보에서 보험상품삭제 버튼을 클릭하였을때 보험상품 아이디를 줘서 삭제하는 쿼리문 -->
		<delete id="insShProdDelete" parameterType="String">
			delete from insshopping 
			where inssp_id = #{inssp_id}
		</delete>
		
		<!-- 플랜정보에서 펫 삭제하기 버튼을 클릭하였을떄 펫의 아이디를 줘서 삭제하는 쿼리문  -->
		<update id="mypetDel" parameterType="String">
			update mypet set myp_del='Y' where myp_id=#{myp_id}
		</update>
		
		<!--반려동물 품종 가지고 오는 쿼리문-->
		<select id="petKind" parameterType="String" resultType="petkindVo">
			select * from petkind , animal
			where petk_am = AM_ID
            and am_name = #{am_name}
            order by petk_id asc
		</select>
		
		<!-- 플랜정보에서 나의 펫에 현재 보험가입이 되어 있는 상품 보여주기 -->
		<select id="petIsrAlready" parameterType="String" resultType="insVo">
			select * from insurance , insprod
			where  inssp_id = insp_id
			and ins_dis= 'N'
			and mem_id = #{mem_id}
		</select>
		
		<!-- 보험가입을 위해서 진행 펫 id를 줘서 해당 펫 정보가지고 오기 -->
		<select id="mypetInfo" parameterType="String" resultType="mypetVo">
			select *
			from mypet , petkind
			where myp_petk = petk_id
			and MYP_ID = #{mem_id}
		</select>
		
		<!-- 펫 정보를 입력하여 추가하기 -->
		<insert id="mypetInsert" parameterType="mypetVo">
			insert into mypet 
			values(mypet_num.nextval, #{myp_mem}, #{myp_petk}, to_char(#{myp_birth},'yyyy-MM-dd')
			       ,#{myp_sick},#{myp_img},	#{myp_neu},#{myp_gender},#{myp_name},'N')
		</insert>
		
		
		<!-- 마이펫에서 번호를 주면 품종 가지고 오는 쿼리문 (플랜정보에서 보험가입할때 이부분이 필요하다) -->
		<select id="petIrsJoinKind" parameterType="String" resultType="petkindVo">
            select * from petkind , mypet ,animal
			where myp_petk = petk_id 
			and PETK_AM = AM_ID
 			and myp_del = 'N'
            and petk_id = #{petk_id}
		</select>
		
		<!-- 보험상품 가입되는 부분 -->
		<insert id="isrProdMypetJoin" parameterType="insVo">
			insert into insurance values (insurancejoin_num.nextval,sysdate,#{ins_end},'신청','N',0,#{myp_id},#{mem_id},#{inssp_id},#{act_id})
		</insert>
		
		<!-- 보험가입이 완료 된다면 해당 플랜정보(장바구니)화면에 해당 상품이 삭제 되도록 만들기 -->
		<delete id="shoppingJoinProd" parameterType="String">
			delete from insshopping where inssp_insp = #{inssp_insp}
		</delete>
		
		
		<!-- 해당 회원의 이메일(pk)로 보내서 회원의 계좌번호를 가지고 오는 방법 -->
		<select id="memAccountList" parameterType="String" resultType="accountVo">
			select * from account where act_mem = #{act_mem}
		</select>
		
		
		<!-- 보상안내 공지사항 나오게 설정 -->
		<select id="insNotice" resultType="insNoticeVo">
			select * from insNotice 
		</select>
		
		<!-- 피보험자 선택하는 부분에 가입이 완료된 상품 나오게 설정 -->
		<select id="insuredPerson" parameterType="String" resultType="insVo">
			select * 
			  from (
			        select a.*
			             , b.*
			             , (
			                select listagg(knd, '<![CDATA[<br>]]>') within group (order by knd) insp_kind
			                  from (
			                        select d.insp_kind ||'('|| c.ins_stat ||')' AS knd
			                             , c.myp_id
			                          from insurance c
			                             , insprod d
			                         where c.INSSP_ID = d.INSP_ID
			                           and ins_dis= 'N'
			                           and c.MEM_ID =  #{mem_id}
			                           and c.ins_stat = '완료'
			                        )
			                 group by  myp_id 
			                 having myp_id = a.myp_id
			               ) AS insp_kind
			          from mypet a 
			             , petkind b 
			         where a.myp_petk = b.petk_id
			           and a.myp_mem = #{mem_id}
			         order by a.myp_id
			       )
			 where insp_kind is not null
		</select>
		
		<!-- 보상안내 - 보험가입할때 해당 펫의 가입되어 있는 보험상품 나오게 설정 -->
		<select id="claimPetJoinProd" parameterType="insVo" resultType="insVo">
			select * from insurance , insprod
			where inssp_id = insp_id
			and ins_stat = '완료'
			and ins_dis= 'N'
			and myp_id = #{myp_id}
			and mem_id = #{mem_id}
		</select>
		
		
		<!-- 보험청구 신청하는 부분 -->
		<insert id="accidentInsert" parameterType="accidentVo">
			insert into accident
			values(accident_num.nextval ,#{accd_date},#{accd_addr},#{accd_text},#{accd_img},#{accd_recp},'신청','','0',#{accd_mem},#{accd_myp},#{accd_ins},#{accd_act},'')
		</insert>
		
		
		<!-- 나의 펫 보험 - 회원이 현재까지 받은 보험금 현황 -->
		<select id="isuranceStatus" parameterType="String" resultType="int">
			select nvl(sum(accd_insp),0) as inspNum
			  from accident
			 where ACCD_MEM = #{mem_id}
			   and ACCD_STAT = '완료'
		</select>
		
		<!--나의펫 보험 - 월 전체 보험료 나오는 부분-->
		<select id="monthlyPremium" parameterType="String" resultType="int">
			select nvl(sum(insp_fees),0) from insurance , insprod
		     where inssp_id = insp_id
			   and mem_id =  #{mem_id}
			   and INS_STAT = '완료'
		</select>
		
		<!-- 나의 펫 보험 - 현재보험금 신청현황(신청) -->
		<select id="isrApply" parameterType="String" resultType="accidentVo">
				select * from accident a , mypet b , insurance c , insprod d , account e
				where a.accd_myp = b.myp_id
				and a.accd_ins = c.ins_id
				and c.inssp_id = d.insp_id
				and a.accd_act = e.act_id
				and a.accd_mem = #{mem_id}
				and a.accd_stat = '신청'
		</select>
		
		<!-- 나의 펫 보험 - 현재보험금 신청현황(반려) -->
		<select id="underExamination" parameterType="String" resultType="accidentVo">
				select * from accident a , mypet b , insurance c , insprod d , account e
				where a.accd_myp = b.myp_id
				and a.accd_ins = c.ins_id
				and c.inssp_id = d.insp_id
				and a.accd_act = e.act_id
				and a.accd_mem = #{mem_id}
				and a.accd_stat = '반려'
		</select>
		
		<!-- 나의 펫 보험 - 현재보험금 신청현황(완료) -->
		<select id="isrComplete" parameterType="String" resultType="accidentVo">
				select * from accident a , mypet b , insurance c , insprod d , account e
				where a.accd_myp = b.myp_id
				and a.accd_ins = c.ins_id
				and c.inssp_id = d.insp_id
				and a.accd_act = e.act_id
				and a.accd_mem = #{mem_id}
				and a.accd_stat = '완료'
		</select>
		
		<!--보험금 신청 현황 화면에서 보험금 신청 취소를 클릭하였을떄 적용되는 부분-->
		<delete id="goAccidentDel" parameterType="String">
			delete from accident 
			where accd_id = #{accd_id}
		</delete>
		
		<!-- 보험금 내역 확인 버튼을 클릭하였을때 나오는 부분 -->
		<select id="history" parameterType="String" resultType="accidentVo">
				select * from accident a , mypet b , insurance c ,insprod d , account e
			   	 where a.accd_myp = b.myp_id
                   and a.ACCD_INS = c.INS_ID
                   and c.inssp_id = d.INSP_ID
                   and a.accd_act = e.act_id
			       and a.accd_id = #{accd_id}
		</select>
		
		<!-- 보험금내역 부분에서 계좌번호를 변경하였을떄 실행  -->
		<update id="accountChange" parameterType="accidentVo">
			update accident set accd_act=#{accd_act} where accd_id=#{accd_id}
		</update>
		
		<!-- 나의 펫 보험 - 보험 가입 되어 있는 가입내역이 나오는 부분 -->
		<select id="claimPetJoinProd1" parameterType="insVo" resultType="insVo">
			select * from insurance , insprod
			where inssp_id = insp_id
			and ins_stat = '완료'
			and ins_dis= 'N'
			and myp_id = #{myp_id}
			and mem_id = #{mem_id}
		</select>
		
		<!-- 나의 펫 보험 화면에서 해당 펫의 가입되어 있는 보험상품 해지 하는 부분(실질적으로 삭제하는 부분이아닌 해지여부에 해지로 변경 -->
		<update id="mypetIsrDel" parameterType="String">
			update insurance 
			   set ins_dis = 'Y' 
			 where ins_id = #{ins_id}
		</update>
		
		<!-- 나의 펫 보험 - 보험 해지 되어 있는 가입내역이 나오는 부분 -->
		<select id="claimPetJoinProd2" parameterType="insVo" resultType="insVo">
			select * from insurance , insprod
			where inssp_id = insp_id
			and ins_stat = '완료'
			and ins_dis= 'Y'
			and myp_id = #{myp_id}
			and mem_id = #{mem_id}
		</select>
		
		
		<!-- 나의 펫 보험 화면에서 펫의 정보 수정하는 부분 -->
		<update id="mypetInfoUpdate" parameterType="mypetVo">
			update mypet set myp_img=#{myp_img}, myp_name=#{myp_name} , myp_birth=#{myp_birth} ,myp_gender=#{myp_gender}  , 
			       myp_sick=#{myp_sick} , myp_neu=#{myp_neu}  
			 where myp_id=#{myp_id}
		</update>
		
		

</mapper>